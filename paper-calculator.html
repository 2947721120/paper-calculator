<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->

<!--
/**
 * @group Quantum Paper Elements
 *
 * A fancy looking calculator that can only perform simple math calculation. 
 * 
 * @element paper-calculator
 * @homepage github.io
 */
-->

<link rel="import" href="../core-media-query/core-media-query.html">
<link rel="import" href="paper-calculator-output.html">
<link rel="import" href="paper-calculator-keypad.html">
<link rel="import" href="paper-calculator-math.html">

<polymer-element name="paper-calculator" attributes="expression result wideMode responsiveWidth" tabindex="0">

  <template>

    <style>
    
      :host {
        display: block;
        position: relative;
        background-color: #eee;
        overflow: hidden;
        
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-touch-callout: none;
        -webkit-font-smoothing: antialiased;
      }
      
      #output {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 38%;
        z-index: 1;
        box-shadow: 0 5px 4px rgba(0, 0, 0, 0.3);
      }
      
      #keypad {
        position: absolute;
        top: 38%;
        bottom: 0;
        width: 100%;
      }
      
      #resultInk {
        position: absolute;
        border-radius: 50%;
        background-color: #73daeb;
        -webkit-transform: scale(0);
        transform: scale(0);
      }
      
      #resultInk.error {
        background-color: #f50057;
      }
      
      #resultInk.spill {
        -webkit-transform: scale(1);
        transform: scale(1);
        -webkit-transition: -webkit-transform 0.38s ease-out 0.2s;
        transition: transform 0.38s ease-out 0.2s;
      }
      
    </style>
    
    <div id="resultInk" class="{{result ? 'spill' : ''}} {{error ? 'error' : ''}}"></div>
    
    <paper-calculator-output id="output" expression="{{expression}}" result="{{result}}" error="{{error}}" class="level{{level}}"></paper-calculator-output>
    
    <paper-calculator-keypad id="keypad" wideMode="{{wideMatches || wideMode}}" standardKeys="{{standardKeys}}" advancedKeys="{{advancedKeys}}" modeKeys="{{modeKeys}}" level="{{level}}" on-cal-keytap="{{keyTap}}"></paper-calculator-keypad>
    
    <paper-calculator-math id="math" expression="{{expression}}" result="{{result}}" error="{{error}}"></paper-calculator-math>
    
    <core-media-query query="min-width: {{responsiveWidth}}" queryMatches="{{wideMatches}}"></core-media-query>
    
  </template>

  <script>

    Polymer('paper-calculator', {
      
      standardKeys: [
        ['7', '4', '1', '.'],
        ['8', '5', '2', '0'],
        ['9', '6', '3', '='],
        ['<small>DEL</small>', '+', '-', '&#247;', '&#215;'],
      ],
      
      advancedKeys: [
        ['2nd', '1/x', 'x!', 'sin', 'sinh', 'EXP'],
        ['(', 'x&#178;', '&#8730;', 'cos', 'cosh', '&#928;'],
        [')', 'x&#179;', '&#8319; &#8730;y', 'tan', 'tanh', 'EE'],
        ['%', 'y&#8319;', 'log', 'ln', 'e&#8319', 'Rand']
      ],
      
      modeKeys: [
        ['Deg', 'Rad', 'func', 'Table', 'Graph', '']
      ],
      
      errorMsgs: ['error...', 'umm...', ':-('],
      
      /**
       * If true, calculator changes to wide layout.
       *
       * @attribute wideMode
       * @type boolean
       * @default false
       */
      wideMode: false,
      
      /**
       * Min-width when calculator changes to wide layout.
       *
       * @attribute responsiveWidth
       * @type string
       * @default ''
       */
      responsiveWidth: '',
      
      /**
       * The expression entered to the calculator.
       *
       * @attribute expression
       * @type string
       * @default ''
       */
      expression: '',
      
      /**
       * The result from evaluating the expression.
       *
       * @attribute result
       * @type string
       * @default ''
       */
      result: '',
      
      level: 0,
      
      eventDelegates: {
        keydown: 'keyDown',
        keypress: 'keyPress'
      },
      
      clear: function() {
        this.expression = '';
        this.result = '';
        this.error = '';
      },
      
      del: function() {
        this.expression = this.expression.slice(0, -1);
      },
      
      eval: function() {
        this.updateResultInk();
        this.$.math.eval();
      },
      
      keyTap: function(e) {
        var k = e.detail.key;
        if (this.modeKeys[0].indexOf(k) < 0) {
          this.processKey(k);
        }
      },
      
      keyDown: function(e) {
        // backspace key
        if (e.keyCode === 8) {
          this.del();
          e.preventDefault();
        }
      },
      
      keyPress: function(e) {
        var c = e.keyCode, k;
        // enter key
        if (c === 13) {
          k = '=';
        } else {
          k = String.fromCharCode(c);
        }
        var key = this.$.keypad.findKey(k);
        if (key) {
          key.inking();
        }
        this.processKey(k);
        e.preventDefault();
      },
      
      processKey: function(k) {
        if (this.result) {
          this.clear();
        }
        if (k === '=') {
          this.eval();
        } else if (k === '<small>DEL</small>') {
          this.del();
        } else {
          this.expression += k;
        }
      },
      
      updateResultInk: function() {
        var rect = this.getBoundingClientRect();
        var keyRect = this.$.keypad.equalKey.getBoundingClientRect();
        var s  = this.$.resultInk.style;
        var t = keyRect.top - rect.top + keyRect.height / 2;
        s.top = -t + 'px';
        s.left = -t * 2 + (keyRect.left - rect.left + keyRect.width / 2) + 'px';
        s.width = s.height = 4 * t + 'px';
      },
      
      resultChanged: function() {
        if (this.result === '?') {
          this.error = this.errorMsgs[Math.floor(Math.random() * 
              this.errorMsgs.length)];
        }
      }
      
    });

  </script>

</polymer-element>