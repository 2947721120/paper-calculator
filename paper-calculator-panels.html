<!--
Copyright 2014 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->

<link rel="import" href="../polymer-selector/polymer-selector.html">
<link rel="import" href="../polymer-media-query/polymer-media-query.html">

<polymer-element name="paper-calculator-panels" extends="polymer-selector" touch-action="pan-y" attributes="wideMode responsiveWidth defaultSelected margin">
  <template>
    
    <style>
    
      :host {
        display: block;
        overflow: hidden;
      }
      
      #panelContainer {
        position: relative;
        height: 100%;
      }
      
      /*@polyfill #panelContainer > * */
      ::content > * {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        transition: -webkit-transform 0.13s linear, width 0.13s linear;
        transition: transform 0.13s linear, width 0.13s linear;
      }
      
      /*@polyfill :host.dragging > #panelContainer > * */
      :host(.dragging) ::content > * {
        transition: none;
      }
      
    </style>
    
    <div id="panelContainer" class="{{wideMode ? 'wide-layout' : '' }}">
      <shadow></shadow>
    </div>
    
    <polymer-media-query query="min-width: {{responsiveWidth}}" queryMatches="{{wideMode}}"></polymer-media-query>
    
  </template>
  
  <script>
  
    Polymer('paper-calculator-panels', {
      
      margin: '12px',
      defaultSelected: 0,
      wideMode: false,
      responsiveWidth: '',
      notap: true,
      
      eventDelegates: {
        trackstart: 'trackStart',
        track: 'track',
        trackend: 'trackEnd'
      },
      
      attached: function() {
        this.marginChanged();
        this.layout();
      },
      
      marginChanged: function() {
        this.$.panelContainer.style.width = 'calc(100% - ' + this.margin + ')';
      },
      
      layout: function() {
        var t = 0;
        this.items.forEach(function(item) {
          var flex = Number(item.getAttribute('flex'));
          item.flex = flex;
          t += flex;
        });
        var l = 0;
        for (var i = this.items.length-1; i >= 0; i--) {
          var item = this.items[i];
          var flex = item.flex;
          item.style.width = (this.wideMode ? flex / t : flex) * 100 + '%';
          this.positionPanel(item, (this.wideMode ? -l / flex : 0) * 100  + '%');
          l += flex;
        }
      },
      
      wideModeChanged: function() {
        this.layout();
        this.setSelectedAlways(this.defaultSelected);
      },
      
      setSelectedAlways: function(selected) {
        var old = this.selected;
        this.selected = selected;
        if (old == this.selected) {
          this.selectedIndexChanged();
        }
      },
      
      selectedIndexChanged: function() {
        if (this.wideMode) {
          return;
        }
        var l = 0;
        for (var i = 0; i < this.items.length; i++) {
          var item = this.items[i];
          var flex = item.flex;
          this.positionPanel(item, l / flex * 100 + '%');
          item.classList.toggle('opened', i <= this.selectedIndex);
          var next = this.items[i + 1];
          l += i < this.selectedIndex ? 0 : (next && next.flex);
        }
      },
      
      positionPanel: function(panel, x) {
        panel._x = x;
        var s = panel.style;
        s.webkitTransform = s.transform = 'translate3d(' + x + ',0,0)';
      },
      
      trackStart: function(e) {
        var i = this.findDistributedTarget(e.target, this.items);
        this.dragDisabled = this.wideMode || i <= 0;
        if (this.dragDisabled) {
          return;
        }
        this.dragIndex = i;
        this.dragItem = this.items[i];
        
        var w = this.$.panelContainer.offsetWidth;
        var b = this.dragIndex > this.selectedIndex;
        this._min = b ? -this.dragItem.flex * w : 0;
        this._max = b ? 0 : this.dragItem.flex * w;
        
        this.items.forEach(function(item) {
          var x = item._x;
          item._startx = (x.slice(-1) === '%' ? 
              item.offsetWidth / 100 : 1) * parseFloat(x, 10);
        });
        
        this.classList.add('dragging');
        this.dragItem.classList.add('dragging');
        e.preventTap();
      },
      
      track: function(e) {
        if (this.dragDisabled) {
          return;
        }
        var x = Math.max(this._min, Math.min(this._max, e.dx));
        for (var i = this.dragIndex; i < this.items.length; i++) {
          this.positionPanel(this.items[i], this.items[i]._startx + x + 'px');
        }
      },
      
      trackEnd: function(e) {
        if (this.dragDisabled) {
          return;
        }
        this.classList.remove('dragging');
        this.dragItem.classList.remove('dragging');
        this.setSelectedAlways(this.dragIndex - (e.xDirection === -1 ? 0 : 1));
      }
      
    });
    
  </script>
  
</polymer-element>